<head>
  <style>
    .questionData {
      display: inline-block;
      border: 1px solid;
      padding: 15px;
      width: 50%;
      height: 300px;
      overflow: auto;
    }
    .questionBox {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div style="margin: 32px">
    <%= raw(@test.name) %>
  </div>
  <div style="margin: 32px">
    <div>
      Question Ids:
      <textarea placeholder="select questions from test or directly paste question ids (Required format : 1,2,3,4,5) ..." id="selectedIds"></textarea>
    </div>
    <p>If you are adding questions from subjcet test then select sequenceId from  below (1 for chemistry and 2 for physics)</p>
    <select name="sequence" id="sequenceList">
      <option value=''>Sequence Id</option>
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
    </select>
    <br/></br>
    <div style="margin-bottom: 30px; margin-top: 15px">
      <button style="width: 300px; padding: 15px" onclick="addTestQuestions()">Add Selected Questions</button>
    </div>
    <label>Tests :</label>
    <select name="test" id="testList" onchange="onTestChange()">
      <option value=''>Select Test</option>
      <% @tests_data.each do |key, value| %>
        <%= raw("<option value='" + key.to_s + "'>" + " (" + key.to_s + ") " + value[0].to_s + "</option>") %>
      <% end %>
    </select>
    <br/></br>
    <div>
      <input type="checkbox" id="selectAllQuestions"></input>
      <label for="selectAllQuestions">Select All Questions</label>
      <span id="selectedIdsCount"></span>
    </div>
    <ul id="questionsList"></ul>
    <br/><br/>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.full.min.js"></script>
  <script type="text/javascript">

    $(function () {
      $("select").select2();
    });

    function onTestChange() {
      $("#questionsList").html("");
      $("#selectAllQuestions"). prop("checked", false);
      $("#selectedIdsCount").html("");
      $("#selectedIds").val("");
      let url = window.location.origin + "/tests/getTestQuestionsList";
      let testId = $('#testList').val();
      $.ajax({
        type: "POST",
        url: url,
        dataType: "json",
        data: {
          "testId": testId
        }
      }).done (function (data) {
        li = "";
        $.each(data, function(key, value) {
          li += "<li class='questionData'><input onchange='pushSelectedIds()' class='questionCheckbox' type='checkbox' id= " + key + "></input><span>(" + key + ") sequenceId: " + value[1]  + "</span><label class='questionBox' for="+ key +">" + value[0] + "</label></li>";
        });
        $("#questionsList").html(li);
      });
    }

    $("#selectAllQuestions").click(function () {
      $(".questionCheckbox").prop('checked', $(this).prop('checked'));
      pushSelectedIds();
    });

    function pushSelectedIds() {
      idCount = 0;
      ids = "";
      $("input:checkbox").each(function(){
        var $this = $(this);
        if($this.is(":checked") && $this.hasClass("questionCheckbox")){
          idCount += 1;
          ids +=  $this.prop("id") + ",";
        }
      });
      $("#selectedIdsCount").html("(" + idCount + ")");
      var textarea = $("#selectedIds");
      var trimIds = ids.replace(/(^,)|(,$)/g, "")
      textarea.val(trimIds);
    }

    function addTestQuestions() {
      let questionIds = $("#selectedIds").val();
      var questionIdsArray = questionIds.split(/[\n,]+/);
      let testId = '<%= @test.id %>';
      let selectedSequenceId = $('#sequenceList').val();
      if (questionIds == ""){
        alert('Questions not selected');
        return
      }
      let url = window.location.origin + "/tests/createTestQuestion";
      $.ajax({
        type: "POST",
        url: url,
        data: {
          "questionIds": questionIdsArray,
          "testId": testId,
          "sequenceId": selectedSequenceId
        }
      }).done (function (data) {
        alert("done");
      });
    }

  </script>
</body>
